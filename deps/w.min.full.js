W={models:{},renderers:{},reset:e=>{W.canvas=e,W.objs=0,W.current={},W.next={},W.textures={},W.gl=e.getContext("webgl2"),W.gl.blendFunc(770,771),W.gl.activeTexture(33984),W.program=W.gl.createProgram(),W.gl.shaderSource(t=W.gl.createShader(35633),"#version 300 es\nprecision highp float;in vec4 pos,col,uv,normal;uniform mat4 pv,eye,m,im;uniform vec4 bb;out vec4 v_pos,v_col,v_uv,v_normal;void main(){gl_Position=pv*(v_pos=bb.z>0.?m[3]+eye*(pos*bb):m*pos);v_col=col;v_uv=uv;v_normal=transpose(inverse(m))*normal;}"),W.gl.compileShader(t),W.gl.attachShader(W.program,t),W.gl.shaderSource(t=W.gl.createShader(35632),"#version 300 es\nprecision highp float;in vec4 v_pos,v_col,v_uv,v_normal;uniform vec3 light;uniform vec4 o;uniform sampler2D sampler;out vec4 c;void main(){c=mix(texture(sampler,v_uv.xy),v_col,o[3]);if(o[1]>0.){if(o[0]>0.){c=vec4(c.rgb*(max(dot(light,-normalize(vec3(v_normal.xyz))),0.)+o[2]),c.a);}else{c=vec4(c.rgb*(max(dot(light,-normalize(cross(dFdx(v_pos.xyz),dFdy(v_pos.xyz)))),0.)+o[2]),c.a);}}}"),W.gl.compileShader(t),W.gl.attachShader(W.program,t),W.gl.linkProgram(W.program),W.gl.useProgram(W.program),W.gl.clearColor(1,1,1,1),W.clearColor=e=>W.gl.clearColor(...W.col(e)),W.clearColor("ffff"),W.gl.enable(2929),W.light({y:-1}),W.camera({fov:30}),W.draw()},setState:(e,t,r,o,i=[],l,a,n,s,m,d,p,g)=>{e.n||="o"+W.objs++,e.size&&(e.w=e.h=e.d=e.size),e.t&&e.t.width&&!W.textures[e.t.id]&&(r=W.gl.createTexture(),W.gl.pixelStorei(37441,!0),W.gl.bindTexture(3553,r),W.gl.pixelStorei(37440,1),W.gl.texImage2D(3553,0,6408,6408,5121,e.t),W.gl.generateMipmap(3553),W.textures[e.t.id]=r),e={type:t,...W.current[e.n]=W.next[e.n]||{w:1,h:1,d:1,x:0,y:0,z:0,rx:0,ry:0,rz:0,b:"888",mode:4,mix:0},...e,f:0},W.models[e.type]?.vertices&&!W.models?.[e.type].verticesBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].verticesBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[e.type].vertices),35044)),W.models[e.type]?.uv&&!W.models[e.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].uvBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[e.type].uv),35044)),W.models[e.type]?.indices&&!W.models[e.type].indicesBuffer&&(W.gl.bindBuffer(34963,W.models[e.type].indicesBuffer=W.gl.createBuffer()),W.gl.bufferData(34963,new Uint16Array(W.models[e.type].indices),35044),!W.models[e.type].smoothNormals&&W.smooth&&W.smooth(e),W.models[e.type].smoothNormals&&(W.gl.bindBuffer(34962,W.models[e.type].smoothNormalsBuffer=W.gl.createBuffer()),W.gl.bufferData(34962,new Float32Array(W.models[e.type].smoothNormals.flat()),35044))),e.t?e.t&&!e.mix&&(e.mix=0):e.mix=1,W.next[e.n]=e,e.fov&&(W.perspective=new DOMMatrix([1/Math.tan(.0175*e.fov)/(W.canvas.width/W.canvas.height),0,0,0,0,1/Math.tan(.0175*e.fov),0,0,0,0,1e3/-998,-1,0,0,1998/-998,0]))},draw:(e,t,r,o,i=[])=>{for(o in t=e-W.lastFrame,W.lastFrame=e,requestAnimationFrame(W.draw),W.gl.clear(16640),r=W.animation("camera"),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"eye"),!1,r.toFloat32Array()),r.invertSelf(),r.preMultiplySelf(W.perspective),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"pv"),!1,r.toFloat32Array()),W.gl.uniform3f(W.gl.getUniformLocation(W.program,"light"),W.lerp("light","x"),W.lerp("light","y"),W.lerp("light","z")),W.next)W.next[o].t||1!=W.col(W.next[o].b)[3]?i.push(W.next[o]):W.render(W.next[o],t);for(o in i.sort(((e,t)=>W.dist(t)-W.dist(e))),W.gl.enable(3042),i)W.render(i[o],t);W.gl.disable(3042)},render:(e,t,r)=>{e.t&&(W.gl.bindTexture(3553,W.textures[e.t.id]),W.gl.uniform1i(W.gl.getUniformLocation(W.program,"sampler"),0)),e.f<e.a&&(e.f+=t),e.f>e.a&&(e.f=e.a),W.next[e.n].m=W.animation(e.n),W.next[e.g]&&W.next[e.n].m.preMultiplySelf(W.next[e.g].M||W.next[e.g].m),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"m"),!1,(W.next[e.n].M||W.next[e.n].m).toFloat32Array()),W.gl.uniformMatrix4fv(W.gl.getUniformLocation(W.program,"im"),!1,new DOMMatrix(W.next[e.n].M||W.next[e.n].m).invertSelf().toFloat32Array()),["camera","light","group"].includes(e.type)||(W.gl.bindBuffer(34962,W.models[e.type].verticesBuffer),W.gl.vertexAttribPointer(r=W.gl.getAttribLocation(W.program,"pos"),3,5126,!1,0,0),W.gl.enableVertexAttribArray(r),W.models[e.type].uvBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].uvBuffer),W.gl.vertexAttribPointer(r=W.gl.getAttribLocation(W.program,"uv"),2,5126,!1,0,0),W.gl.enableVertexAttribArray(r)),e.s&&W.models[e.type].smoothNormalsBuffer&&(W.gl.bindBuffer(34962,W.models[e.type].smoothNormalsBuffer),W.gl.vertexAttribPointer(r=W.gl.getAttribLocation(W.program,"normal"),3,5126,!1,0,0),W.gl.enableVertexAttribArray(r)),W.gl.uniform4f(W.gl.getUniformLocation(W.program,"o"),e.s,(e.mode>3||W.gl[e.mode]>3)&&!e.ns?1:0,W.ambientLight||.2,e.mix),W.gl.uniform4f(W.gl.getUniformLocation(W.program,"bb"),e.w,e.h,"billboard"==e.type,0),W.models[e.type].indicesBuffer&&W.gl.bindBuffer(34963,W.models[e.type].indicesBuffer),e.r?W.renderers[e.r](e):(W.gl.vertexAttrib4fv(W.gl.getAttribLocation(W.program,"col"),W.col(e.b)),W.models[e.type].indicesBuffer?W.gl.drawElements(+e.mode||W.gl[e.mode],W.models[e.type].indices.length,5123,0):W.gl.drawArrays(+e.mode||W.gl[e.mode],0,W.models[e.type].vertices.length/3)))},lerp:(e,t)=>W.next[e]?.a?W.current[e][t]+(W.next[e][t]-W.current[e][t])*(W.next[e].f/W.next[e].a):W.next[e][t],animation:(e,t=new DOMMatrix)=>W.next[e]?t.translateSelf(W.lerp(e,"x"),W.lerp(e,"y"),W.lerp(e,"z")).rotateSelf(W.lerp(e,"rx"),W.lerp(e,"ry"),W.lerp(e,"rz")).scaleSelf(W.lerp(e,"w"),W.lerp(e,"h"),W.lerp(e,"d")):t,dist:(e,t=W.next.camera)=>e?.m&&t?.m?(t.m.m41-e.m.m41)**2+(t.m.m42-e.m.m42)**2+(t.m.m43-e.m.m43)**2:0,ambient:e=>W.ambientLight=e,col:e=>(e=e.replace("#","")).length<5?[...[...e].map((e=>("0x"+e)/15)),1]:[...e.match(/../g).map((e=>("0x"+e)/255)),1],add:(e,t)=>{W.models[e]=t,W[e]=t=>W.setState(t,e)},group:e=>W.setState(e,"group"),move:(e,t)=>setTimeout((()=>{W.setState(e)}),t||1),delete:(e,t)=>setTimeout((()=>{delete W.next[e.n]}),t||1),camera:(e,t)=>setTimeout((()=>{W.setState(e,e.n="camera")}),t||1),light:(e,t)=>t?setTimeout((()=>{W.setState(e,e.n="light")}),t):W.setState(e,e.n="light")},W.smooth=(e,t={},r=[])=>{for(W.models[e.type].smoothNormals=[],i=0;i<W.models[e.type].vertices.length;i+=3)r.push([W.models[e.type].vertices[i],W.models[e.type].vertices[i+1],W.models[e.type].vertices[i+2]]);if(W.models[e.type].indices){for(i=0;i<W.models[e.type].indices.length;i+=3)A=r[Ai=W.models[e.type].indices[i]],B=r[Bi=W.models[e.type].indices[i+1]],C=r[Ci=W.models[e.type].indices[i+2]],AB=[B[0]-A[0],B[1]-A[1],B[2]-A[2]],BC=[C[0]-B[0],C[1]-B[1],C[2]-B[2]],normal=[AB[1]*BC[2]-AB[2]*BC[1],AB[2]*BC[0]-AB[0]*BC[2],AB[0]*BC[1]-AB[1]*BC[0]],t[A[0]+"_"+A[1]+"_"+A[2]]||=[0,0,0],t[B[0]+"_"+B[1]+"_"+B[2]]||=[0,0,0],t[C[0]+"_"+C[1]+"_"+C[2]]||=[0,0,0],t[A[0]+"_"+A[1]+"_"+A[2]]=t[A[0]+"_"+A[1]+"_"+A[2]].map(((e,t)=>e+normal[t])),t[B[0]+"_"+B[1]+"_"+B[2]]=t[B[0]+"_"+B[1]+"_"+B[2]].map(((e,t)=>e+normal[t])),t[C[0]+"_"+C[1]+"_"+C[2]]=t[C[0]+"_"+C[1]+"_"+C[2]].map(((e,t)=>e+normal[t]));for(i=0;i<W.models[e.type].indices.length;i+=3)A=r[Ai=W.models[e.type].indices[i]],B=r[Bi=W.models[e.type].indices[i+1]],C=r[Ci=W.models[e.type].indices[i+2]],W.models[e.type].smoothNormals[Ai]=t[A[0]+"_"+A[1]+"_"+A[2]],W.models[e.type].smoothNormals[Bi]=t[B[0]+"_"+B[1]+"_"+B[2]],W.models[e.type].smoothNormals[Ci]=t[C[0]+"_"+C[1]+"_"+C[2]]}else{for(i=0;i<r.length;i+=3)A=r[i],B=r[i+1],C=r[i+2],AB=[B[0]-A[0],B[1]-A[1],B[2]-A[2]],BC=[C[0]-B[0],C[1]-B[1],C[2]-B[2]],normal=[AB[1]*BC[2]-AB[2]*BC[1],AB[2]*BC[0]-AB[0]*BC[2],AB[0]*BC[1]-AB[1]*BC[0]],t[A[0]+"_"+A[1]+"_"+A[2]]=t[A[0]+"_"+A[1]+"_"+A[2]].map(((e,t)=>e+normal[t])),t[B[0]+"_"+B[1]+"_"+B[2]]=t[B[0]+"_"+B[1]+"_"+B[2]].map(((e,t)=>e+normal[t])),t[C[0]+"_"+C[1]+"_"+C[2]]=t[C[0]+"_"+C[1]+"_"+C[2]].map(((e,t)=>e+normal[t]));for(i=0;i<r.length;i+=3)A=r[i],B=r[i+1],C=r[i+2],W.models[e.type].smoothNormals[Ai]=t[A[0]+"_"+A[1]+"_"+A[2]],W.models[e.type].smoothNormals[Bi]=t[B[0]+"_"+B[1]+"_"+B[2]],W.models[e.type].smoothNormals[Ci]=t[C[0]+"_"+C[1]+"_"+C[2]]}},W.models.plane=W.models.billboard={vertices:[.5,.5,0,-.5,.5,0,-.5,-.5,0,.5,.5,0,-.5,-.5,0,.5,-.5,0],uv:[1,1,0,1,0,0,1,1,0,0,1,0]},W.plane=e=>W.setState(e,"plane"),W.billboard=e=>W.setState(e,"billboard"),W.models.cube={vertices:[.5,.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5,-.5,.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,-.5,.5,.5,.5,.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]},W.cube=e=>W.setState(e,"cube"),W.models.pyramid={vertices:[-.5,-.5,.5,.5,-.5,.5,0,.5,0,.5,-.5,.5,.5,-.5,-.5,0,.5,0,.5,-.5,-.5,-.5,-.5,-.5,0,.5,0,-.5,-.5,-.5,-.5,-.5,.5,0,.5,0,.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],uv:[0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,0,0,1,0,.5,1,1,1,0,1,0,0,1,1,0,0,1,0]},W.pyramid=e=>W.setState(e,"pyramid"),((e,t,r,o,i,l,a=[],n=[],s=[],m=15)=>{for(r=0;r<=m;r++)for(o=r*Math.PI/m,e=0;e<=m;e++)t=2*e*Math.PI/m,a.push(+(Math.sin(t)*Math.sin(o)/2).toFixed(6),+(Math.cos(o)/2).toFixed(6),+(Math.cos(t)*Math.sin(o)/2).toFixed(6)),s.push(3.5*Math.sin(e/m),-Math.sin(r/m)),e<m&&r<m&&(l=(i=r*(m+1)+e)+(m+1),n.push(i,l,i+1,i+1,l,l+1));W.models.sphere={vertices:a,uv:s,indices:n}})(),W.sphere=e=>W.setState(e,"sphere")